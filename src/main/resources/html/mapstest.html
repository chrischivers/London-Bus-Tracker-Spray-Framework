<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Bus Route UI</title>

    <style type="text/css">
        html, body, #map_canvas {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

    </style>

    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxCYp9RWcbhuPg0nLWFzJhuPbECQYOqBw"></script>
    <script src="js/jquery-2.1.4.min.js"></script>

    <script>
        var map;
        var symbolArray = {};
        var polyLineArray = {};
        var intervalFunctionArray = {};
        var nextArrivalTimeArray = {}

        var image = 'images/bus_icon.png';
        function initialize() {
            var myLatlng = new google.maps.LatLng(32.520204, 34.937258);
            var mapOptions = {
                zoom: 4,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);


            var source = new EventSource("/stream");
            source.onmessage = function (event) {
                var parsedJson = JSON.parse(event.data);
                if (parsedJson.nextArr != "0") {
                    setNewLocation(parsedJson.reg, parsedJson.nextArr, parsedJson.latLng);
                } else {
                    deleteVehicle(parsedJson.reg);
                }
            };

        }
        $(function () {
            initialize();

        });

        function deleteVehicle(reg) {
            polyLineArray[reg].setMap(null);
            clearSetInterval(intervalFunctionArray[reg]);
            delete polyLineArray[reg];
            delete symbolArray[reg];
            delete intervalFunctionArray[reg];
            delete nextArrivalTimeArray[reg];
        }


        function setNewLocation(reg, nextArr, latLng) {

            var latLngArray = [];
            var parsedJson = JSON.parse(latLng);
            for (var i = 0; i < parsedJson.length; i++) {
                var splitLatLng = parsedJson[i].split(",");
                latLngArray[i] = new google.maps.LatLng(splitLatLng[0], splitLatLng[1]);
            }

            if (reg in symbolArray) {

                var timeTilCompleted = (nextArrivalTimeArray[reg] - Date.now());

                setTimeout(function(){

                    var newPolyLine = new google.maps.Polyline({
                        strokeOpacity: 1,
                        path: latLngArray,
                        icons: [{
                            icon: symbolArray[reg],
                            offset: '0%'
                        }],
                        map: map
                    });

                    polyLineArray[reg].setMap(null);
                    polyLineArray[reg] = newPolyLine;
                    animateCircle(reg, newPolyLine, nextArr);


                }, timeTilCompleted);


            } else {
                var lineSymbol = {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 6,
                    strokeColor: 'red',
                    strokeOpacity:1
                };

                var newPolyLine = new google.maps.Polyline({
                    strokeOpacity: 1,
                    path: latLngArray,
                    icons: [{
                        icon: lineSymbol,
                        offset: '0%'
                    }],
                    map: map
                });

                symbolArray[reg] = lineSymbol;
                polyLineArray[reg] = newPolyLine;

                animateCircle(reg, newPolyLine, nextArr);
            }

        }

        function animateCircle(reg, polyLine, nextArr) {
            var refreshTimeMs = 200;
            var nextArrivalTime = parseInt(nextArr);
            var dur = (nextArrivalTime - Date.now());
            var onePercentDur = (dur/100);
            var perentIncreaseEachRefresh = refreshTimeMs/onePercentDur;
            var acc = 0;
            var setIntervalFunction = window.setInterval(function () {
                if (Math.round(acc) != 100) {
                    acc = acc + perentIncreaseEachRefresh;
                    var icons = polyLine.get('icons');
                    icons[0].offset = acc + '%';
                    polyLine.set('icons', icons);
                } else {
                    //clearSetIntervalFunction(setIntervalFunction)
                }
            }, refreshTimeMs);

            clearSetInterval(intervalFunctionArray[reg]);
            intervalFunctionArray[reg] = setIntervalFunction;
            nextArrivalTimeArray[reg] = nextArrivalTime
            setIntervalFunction
        }

        function clearSetInterval(myInterval) {
            window.clearInterval(myInterval);
        };

    </script>
</head>
<body>
<div id="map_canvas"></div>
</body>
</html>