<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Bus Route UI</title>

    <style type="text/css">
        html, body, #map_canvas {
            width: 100%;
            height: 90%;
            margin: 0;
            padding: 0;
        }

    </style>

    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxCYp9RWcbhuPg0nLWFzJhuPbECQYOqBw"></script>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/markerAnimate.js"></script>
    <script src="js/SlidingMarker.min.js"></script>

    <script>
        //SlidingMarker.initializeGlobally();
        var map;
        var markerArray = {};
        function initialize() {
            var myLatlng = new google.maps.LatLng(32.520204, 34.937258);
            var mapOptions = {
                zoom: 4,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);


            //marker = new google.maps.Marker({
          /*  marker = new SlidingMarker({
                position: myLatlng,
                map: map,
                title: 'I\m sliding marker',
                duration: 2000
            });*/

        }
        $(function () {
            initialize();

        });


        function setNewLocation(reg, lat, lng, duration) {
            var newLatlng = new google.maps.LatLng(lat, lng);
            var currentTimeMillis = new Date().getTime();
           // var timeToArrival = (parseInt(duration) - currentTimeMillis);
            var timeToArrival = 1;
            //alert(timeToArrival)
            if (timeToArrival > 0) {
                if(reg in markerArray) {
                    markerArray[reg].setPosition(newLatlng)
                } else {
                    var marker = new SlidingMarker({
                        position: newLatlng,
                        map: map,
                        id: reg
                    });
                    markerArray[reg] = marker;
                }



               // marker.setDuration(timeToArrival);
               // marker.setPosition(newLatlng);
            }
        }

        $(document).ready(function () {
            $("button").click(function () {
                $.post("getPosition.asp",
                        {
                            name: "bus_reg"
                        },
                        function (data, status) {
                            var parsedJson = JSON.parse(data);

                            for (x in parsedJson) {
                                setNewLocation(parsedJson[x].reg, parsedJson[x].lat,parsedJson[x].lng, parsedJson[x].arrivalTime);
                           }

                        });
                // setTimeout(arguments.callee, 1000);
            });
        });
    </script>
</head>
<body>
<div id="map_canvas"></div>
<button>Send an HTTP POST request to a page and get the result back</button>
</body>
</html>