<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Bus Route UI</title>

    <style type="text/css">
        html, body, #map_canvas {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

    </style>

    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxCYp9RWcbhuPg0nLWFzJhuPbECQYOqBw"></script>
    <script src="https://code.jquery.com/jquery.min.js"></script>

    <script>
        var map;
        var symbolArray = {};
        var polyLineArray = {};
        var image = 'images/bus_icon.png';
        function initialize() {
            var myLatlng = new google.maps.LatLng(32.520204, 34.937258);
            var mapOptions = {
                zoom: 4,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);


            var source = new EventSource("/stream");
            source.onmessage = function (event) {
                var parsedJson = JSON.parse(event.data);
                setNewLocation(parsedJson.reg, parsedJson.dur, parsedJson.latLng);

            };

        }
        $(function () {
            initialize();

        });


        function setNewLocation(reg, dur, latLng) {

            var latLngArray = [];
            var parsedJson = JSON.parse(latLng);
            for (var i = 0; i < parsedJson.length; i++) {
                var splitLatLng = parsedJson[i].split(",");
                latLngArray[i] = new google.maps.LatLng(splitLatLng[0], splitLatLng[1]);
            }

            if (reg in symbolArray) {
                // markerArray[reg].setDuration(parseInt(dur))
                //markerArray[reg].setPosition(newLatlng)

                var newPolyLine = new google.maps.Polyline({
                    strokeOpacity: 1,
                    path: latLngArray,
                    icons: [{
                        icon: symbolArray[reg],
                        offset: '0%'
                    }],
                    map: map
                });


                polyLineArray[reg] = newPolyLine;
               // polyLineArray[reg].setMap(null);

                animateCircle(newPolyLine, dur);



            } else {

                var lineSymbol = {
                    path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                    scale: 6,
                    strokeColor: 'red',
                    strokeOpacity: 1
                };

                var newPolyLine = new google.maps.Polyline({
                    strokeOpacity: 1,
                    path: latLngArray,
                    icons: [{
                        icon: lineSymbol,
                        offset: '0%'
                    }],
                    map: map
                });

                symbolArray[reg] = lineSymbol;
                polyLineArray[reg] = newPolyLine;

                animateCircle(newPolyLine, dur);
            }

        }

        function animateCircle(polyLine, dur) {
            var refreshTimeMs = 200;
            var onePercentDur = (parseInt(dur)/100);
            var perentIncreaseEachRefresh = refreshTimeMs/onePercentDur;
            var acc = 0;
            var setIntervalFunction = window.setInterval(function () {
                if (Math.round(acc) != 100) {
                    acc = acc + perentIncreaseEachRefresh;
                    var icons = polyLine.get('icons');
                    icons[0].offset = acc + '%';
                    polyLine.set('icons', icons);
                } else {
                    clearSetIntervalFunction(setIntervalFunction)
                }
            }, refreshTimeMs);

            var clearSetIntervalFunction = function (myInterval) {
                clearInterval(myInterval);
            };

            setIntervalFunction


        }

    </script>
</head>
<body>
<div id="map_canvas"></div>
</body>
</html>