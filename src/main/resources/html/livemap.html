<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Bus Route UI</title>

    <link href="css/map.css" rel="stylesheet" />
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxCYp9RWcbhuPg0nLWFzJhuPbECQYOqBw"></script>
    <script src="js/jquery-2.1.4.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/markerAnimate.js"></script>
    <script src="js/SlidingMarker.min.js"></script>
    <script src="js/infobox.js" type="text/javascript"></script>
    <script>
        SlidingMarker.initializeGlobally();
    </script>
    <script src="js/markerwithlabel.terikon.js"></script>

    <script>
       var wsUri = "ws://bbkproject.cloudapp.net/";
      //  var wsUri = "ws://localhost:8080/";
        var map;
        var markerArray = {};
        var nextArrivalTimeArray = {};
        var infoBoxArray = {};
        var markerOverListenerArray = {};
        var markerOutListenerArray = {};
       var symbolSVGpath = 'm 0.2867573,14.630228 c 0.1596399,-0.447862 0.604641,-1.144956 0.9888883,-1.549102 3.3114099,-3.4828065 9.0535384,-0.458431 7.9402813,4.182138 -0.464232,1.935144 -2.526414,3.539572 -4.549433,3.539572 -1.1708892,0 -2.5316956,-0.628303 -3.3992412,-1.569478 -1.2393944,-1.344584 -1.5770208,-2.929616 -0.9804954,-4.60313 z m 2.8270798,3.036826 c 0.4907982,0.490807 0.7980782,0.614231 1.529212,0.614231 0.503249,0 1.1121211,-0.138077 1.3530463,-0.306829 1.0655523,-0.746342 1.1491872,-2.565745 0.160637,-3.494434 -0.4214088,-0.395883 -0.7685987,-0.506397 -1.5909541,-0.506397 -0.8920223,0 -1.1289938,0.08961 -1.5590384,0.589572 -0.7596075,0.883092 -0.7112178,2.285551 0.1070972,3.103857 z M 0.2824915,50.15455 c 0.6619871,-1.856147 2.4372399,-3.072426 4.4967874,-3.080889 1.4027018,-0.0061 2.3036113,0.412956 3.364195,1.563555 2.7002651,2.929443 0.57595,7.66831 -3.4375035,7.66831 -3.1929458,0 -5.4819995,-3.182992 -4.4234789,-6.150976 z m 2.8636689,2.992095 c 1.3862194,1.386219 3.7661738,0.506682 3.7661738,-1.39182 0,-2.130984 -2.5245512,-3.115173 -3.8747362,-1.510562 -0.7814657,0.928715 -0.7393534,2.054466 0.1085624,2.902382 z M 3.1824895,0.7850813 C 3.7019522,0.1010018 4.5881133,0 10.070597,0 l 5.442385,0 0.690226,0.6013029 0.690236,0.6013028 5.463375,0.2452778 c 8.371498,0.375837 8.249236,0.3549673 8.717413,1.4881055 0.150033,0.3631435 0.20183,10.500911 0.163741,32.050601 l -0.05575,31.519459 -0.483558,1.050648 c -0.611777,1.329246 -1.53992,2.300785 -2.878522,3.013112 l -1.050647,0.559095 -9.845531,0 -9.8455391,0 -2.0781368,-6.724151 C 3.8573089,60.706469 2.9216137,57.618644 2.9209634,57.542925 c -6.936e-4,-0.07569 0.5493236,-0.08775 1.2221662,-0.0267 3.5750513,0.32417 6.5514434,-2.369914 6.5514434,-5.930053 0,-1.475481 -0.602976,-2.836045 -1.7773331,-4.010411 C 7.5529575,46.211482 6.1834027,45.708068 4.2568162,45.862714 l -1.337032,0.107322 0,-12.177477 0,-12.177486 0.4727898,0.159042 C 4.2890182,22.075672 6.1657497,21.910249 7.1622246,21.441846 10.806352,19.728908 11.732727,15.21158 9.0633449,12.171321 7.9696149,10.925632 6.663649,10.401452 4.6537744,10.401452 l -1.7331405,0 -3.468e-4,-4.6352185 C 2.9199403,2.3820527 2.9907777,1.0376508 3.1825242,0.7851159 Z m 3.3169329,7.8440492 c 0.2101365,0.392649 0.5403411,0.406444 9.7289996,0.406444 7.11765,0 9.574944,-0.06347 9.763639,-0.252153 0.155443,-0.155444 0.252153,-0.91826 0.252153,-1.988841 0,-1.518781 -0.05246,-1.764761 -0.418209,-1.960496 -0.282769,-0.151342 -3.449539,-0.20477 -9.778804,-0.16499 -8.0481931,0.05055 -9.3885202,0.103014 -9.5597351,0.374017 -0.2686012,0.425145 -0.2597573,3.078322 0.011965,3.586019 z M 18.281354,24.500071 c 0.395649,0.358063 0.792356,0.400296 3.760269,0.400296 2.967914,0 3.36462,-0.04222 3.760269,-0.400296 0.428701,-0.387958 0.442322,-0.573627 0.442322,-6.026216 0,-4.740409 -0.05003,-5.67593 -0.317702,-5.943629 -0.465524,-0.465524 -1.933904,-0.621644 -4.754394,-0.505478 -3.606647,0.148541 -3.333086,-0.382201 -3.333086,6.466665 0,5.434745 0.0137,5.620762 0.442322,6.008658 z m -0.144215,14.491355 c 0.274774,0.375958 0.57654,0.407891 3.854768,0.407891 2.705512,0 3.639889,-0.06902 3.904476,-0.288396 0.307913,-0.255292 0.347831,-0.93664 0.347831,-5.936165 0,-5.367593 -0.02081,-5.668621 -0.420255,-6.068025 -0.384742,-0.384741 -0.700432,-0.420264 -3.735585,-0.420264 -2.660529,0 -3.407556,0.06459 -3.782327,0.327109 -0.46281,0.32417 -0.467015,0.377719 -0.467015,5.948538 0,4.521897 0.05835,5.701205 0.298107,6.029312 z m 0.158781,14.31544 c 0.441264,0.469703 0.573757,0.486333 3.875482,0.486333 3.294477,0 3.430472,-0.01699 3.745703,-0.467015 0.27552,-0.39336 0.327109,-1.321261 0.327109,-5.883632 0,-6.876967 0.381967,-6.310779 -4.195438,-6.218864 -2.919472,0.05861 -3.380418,0.115759 -3.768072,0.467093 -0.426828,0.386831 -0.441672,0.580616 -0.441672,5.76502 0,5.218895 0.0124,5.377946 0.456888,5.851065 z m 0.01014,14.868301 c 0.7084,0.496184 5.459196,0.466027 6.449437,-0.04092 1.373135,-0.70299 1.48873,-1.223648 1.48873,-6.705292 l 0,-4.873545 -0.553659,-0.435515 c -0.5039,-0.396369 -0.835266,-0.435507 -3.686822,-0.435507 -3.04639,0 -3.147444,0.01431 -3.648933,0.515769 l -0.515769,0.515778 0,5.566076 c 0,5.513612 0.0043,5.569155 0.467016,5.893177 z';



        function initialize() {
            loadRouteIDs();
            var startingPoint = new google.maps.LatLng(51.504041, -0.124283);
            var mapOptions = {
                zoom:11,
                center: startingPoint,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);

            document.getElementById("runButton").addEventListener("click", function(){
                var selectedValues = $('#routeIDOption').val();
                setUpWebSocket(selectedValues.join());
                $('#settings_canvas').css('visibility', 'hidden');
            });

        }
        $(function () {
            initialize();
        });


        function deleteVehicle(reg) {
            markerArray[reg].setMap(null);
            delete markerArray[reg];
            delete nextArrivalTimeArray[reg];
            delete infoBoxArray[reg];
            delete markerOverListenerArray[reg];
            delete markerOutListenerArray[reg];
        }
        function setNewLocation(reg, nextArr, movementData, routeID, directionID, towards, nextStopID, nextStopName) {
            var latLngArray = [];
            var rotationArray = [];
            var proportionalDurationArray = [];
            var labelPosArray = [];

            var parsedmovementDataArray = JSON.parse(movementData);
            for (var i = 0; i < parsedmovementDataArray.length; i++) {
                var splitArray = parsedmovementDataArray[i].split(",");
                latLngArray[i] = new google.maps.LatLng(splitArray[0], splitArray[1]);
                rotationArray[i] = parseInt(splitArray[2]);
                proportionalDurationArray[i] = splitArray[3];
                labelPosArray[i] = new google.maps.Point(splitArray[4], splitArray[5]);
            }

            if(reg in markerArray) {
                var timeTilCompleted = (nextArrivalTimeArray[reg] - Date.now());
               // alert("Next arrival time array = " + nextArrivalTimeArray[reg] + ". Date now: " + Date.now() + " Time till completed: " + timeTilCompleted);
                setTimeout(function(){
                    moveMarker(reg, latLngArray, rotationArray, proportionalDurationArray, labelPosArray, nextArr, routeID, directionID, towards, nextStopID, nextStopName);
                }, timeTilCompleted);
            } else {

                markerArray[reg] = new MarkerWithLabel({
                    position: latLngArray[0],
                    //icon: 'images/bus_icon.png',
                    icon: {
                        anchor: new google.maps.Point(0, 28),
                        path: symbolSVGpath,
                        scale: 0.8,
                        fillColor: "#D40000",
                        fillOpacity: 1
                    },
                    map: map,
                    labelContent: routeID,
                    labelClass: "labels",
                    visible: false,
                    easing: "linear"
                });



                moveMarker(reg, latLngArray, rotationArray, proportionalDurationArray, labelPosArray, nextArr, routeID, directionID, towards, nextStopID, nextStopName);
            }
        }
        function moveMarker(reg, latLngArray, rotationArray, proportionalDurationArray, labelPosArray, nextArr, routeID, directionID, towards, nextStopID, nextStopName) {
           // alert("move requested");

            var nextArrivalTime = parseInt(nextArr);
            var latLngLength = latLngArray.length;
            var dur = (nextArrivalTime - Date.now());

            var timeOutAcc = 0;
            for (i = 0; i < latLngLength; i++) {
                var actualDuration = Math.round(dur * proportionalDurationArray[i]);
                timeoutFunc(reg,actualDuration,latLngArray[i],labelPosArray[i], rotationArray[i], timeOutAcc);
                timeOutAcc  = timeOutAcc + actualDuration;
            }

            //infoBoxArray[reg].close();
            delete markerOverListenerArray[reg];
            delete markerOutListenerArray[reg];
            delete infoBoxArray[reg];

            infoBoxArray[reg] = new google.maps.InfoWindow({
                content: "Route: " + routeID + "<br />" + "Direction: " + directionID + "<br />" +  "Towards: "+ towards + "<br />" +  "Next Stop ID: " + nextStopID + "<br />" +  "Next Stop Name: " + nextStopName,
            });



            markerOverListenerArray[reg] = google.maps.event.addListener( markerArray[reg], 'mouseover', function() {
                infoBoxArray[reg].open(map, this);
            });

            markerOutListenerArray[reg] = google.maps.event.addListener( markerArray[reg], 'mouseout', function() {
                infoBoxArray[reg].close();
            });

            nextArrivalTimeArray[reg] = nextArrivalTime;

            function timeoutFunc(reg, actualDuration, position, labelPosition, rotation, timeOut){
                setTimeout(function(){
                    if (timeOut > 0) { markerArray[reg].setVisible(true);}
                    markerArray[reg].setDuration(actualDuration);
                    markerArray[reg].labelAnchor = labelPosition;
                    markerArray[reg].label.setStyles();
                     markerArray[reg].setIcon({
                         anchor: new google.maps.Point(0, 28),
                         path: symbolSVGpath,
                         fillColor: "#D40000",
                         fillOpacity: 1,
                         scale: 0.8,
                         rotation: rotation
                     });
                     markerArray[reg].setPosition(position);
                },timeOut);
            }
        }


        function loadRouteIDs()
        {
            var routeIdCombo = document.getElementById("routeIDOption");
            var xmlhttp =new XMLHttpRequest();
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState==4 && xmlhttp.status==200)
                {
                    var parsedJson = JSON.parse(xmlhttp.responseText);
                    var routeArray = parsedJson.routeList;

                    for(var i = 0; i < routeArray.length; i++) {
                        var opt = routeArray[i];
                        var el = document.createElement("option");
                        el.textContent = opt;
                        el.value = opt;
                        routeIdCombo.appendChild(el);
                    }
                }
            };
            xmlhttp.open("GET","route_list_request.asp",true);
            xmlhttp.send();
        }

        function setUpWebSocket(routeSelection) {
            websocket = new WebSocket(wsUri);
            websocket.onopen = function(evt) {
                onOpen(evt, routeSelection)
            };
            websocket.onclose = function(evt) {
                onClose(evt)
            };
            websocket.onmessage = function(evt) {
                onMessage(evt)
            };
            websocket.onerror = function(evt) {
                onError(evt)
            };
        }
        function onOpen(evt, routeSelection) {
            doSend(routeSelection);
        }
        function onClose(evt) {
            alert("DISCONNECTED");
        }
        function onMessage(evt) {
                var parsedJson = JSON.parse(evt.data);
                if (parsedJson.nextArr != "kill") {
                    setNewLocation(parsedJson.reg, parsedJson.nextArr, parsedJson.movementData, parsedJson.routeID, parsedJson.directionID, parsedJson.towards, parsedJson.nextStopID, parsedJson.nextStopName);
                }else {
                    deleteVehicle(parsedJson.reg);
                }
            }
        function onError(evt) {
            alert("ERROR: " + evt.data);
        }
        function doSend(message) {
            websocket.send(message);
        }

    </script>
</head>
<body>
<div id="map_canvas"></div>
<div id="settings_canvas" class="settings">
    <div class="content">
    <div class="row">
        <label for="routeIDOption">Choose Route:</label>
        <select id="routeIDOption" multiple>
        </select>
            <button id="runButton">Run</button>
        </div>
    </div>
</div>

</body>
</html>