<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Bus Route UI</title>

    <link href="css/map.css" rel="stylesheet" />
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxCYp9RWcbhuPg0nLWFzJhuPbECQYOqBw"></script>
    <script src="js/jquery-2.1.4.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/markerAnimate.js"></script>
    <script src="js/SlidingMarker.min.js"></script>
    <script src="js/infobox.js" type="text/javascript"></script>
    <script>
        SlidingMarker.initializeGlobally();
    </script>
    <script src="js/markerwithlabel.terikon.js"></script>

    <script>
        var wsUri = "ws://0.0.0.0:8080/";
        var map;
        var markerArray = {};
        var nextArrivalTimeArray = {};
        var infoBoxArray = {};
        var markerOverListenerArray = {};
        var markerOutListenerArray = {};



        function initialize() {
            loadRouteIDs();
            var startingPoint = new google.maps.LatLng(51.504041, -0.124283);
            var mapOptions = {
                zoom:11,
                center: startingPoint,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);

            document.getElementById("runButton").addEventListener("click", function(){
                var selectedValues = $('#routeIDOption').val();
                setUpWebSocket(selectedValues.join());
                $('#settings_canvas').css('visibility', 'hidden');
            });

        }
        $(function () {
            initialize();
        });


        function deleteVehicle(reg) {
            markerArray[reg].setMap(null);
            delete markerArray[reg];
            delete nextArrivalTimeArray[reg];
            delete infoBoxArray[reg];
            delete markerOverListenerArray[reg];
            delete markerOutListenerArray[reg];
        }
        function setNewLocation(reg, nextArr, movementData, routeID, directionID, towards, nextStopID, nextStopName) {
            var latLngArray = [];
            var rotationArray = [];
            var proportionalDurationArray = [];
            var labelPosArray = [];

            var parsedmovementDataArray = JSON.parse(movementData);
            for (var i = 0; i < parsedmovementDataArray.length; i++) {
                var splitArray = parsedmovementDataArray[i].split(",");
                latLngArray[i] = new google.maps.LatLng(splitArray[0], splitArray[1]);
                rotationArray[i] = parseInt(splitArray[2]);
                proportionalDurationArray[i] = splitArray[3];
                labelPosArray[i] = new google.maps.Point(splitArray[4], splitArray[5]);
            }

            if(reg in markerArray) {
                var timeTilCompleted = (nextArrivalTimeArray[reg] - Date.now());
               // alert("Next arrival time array = " + nextArrivalTimeArray[reg] + ". Date now: " + Date.now() + " Time till completed: " + timeTilCompleted);
                setTimeout(function(){
                    moveMarker(reg, latLngArray, rotationArray, proportionalDurationArray, labelPosArray, nextArr, routeID, directionID, towards, nextStopID, nextStopName);
                }, timeTilCompleted);
            } else {

                markerArray[reg] = new MarkerWithLabel({
                    position: latLngArray[0],
                    //icon: 'images/bus_icon.png',
                    icon: {
                        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                        scale: 8
                    },
                    map: map,
                    labelContent: routeID,
                    labelClass: "labels",
                    visible: false,
                    easing: "linear"
                });



                moveMarker(reg, latLngArray, rotationArray, proportionalDurationArray, labelPosArray, nextArr, routeID, directionID, towards, nextStopID, nextStopName);
            }
        }
        function moveMarker(reg, latLngArray, rotationArray, proportionalDurationArray, labelPosArray, nextArr, routeID, directionID, towards, nextStopID, nextStopName) {
           // alert("move requested");

            var nextArrivalTime = parseInt(nextArr);
            var latLngLength = latLngArray.length;
            var dur = (nextArrivalTime - Date.now());

            var timeOutAcc = 0;
            for (i = 0; i < latLngLength; i++) {
                var actualDuration = Math.round(dur * proportionalDurationArray[i]);
                timeoutFunc(reg,actualDuration,latLngArray[i],labelPosArray[i], rotationArray[i], timeOutAcc);
                timeOutAcc  = timeOutAcc + actualDuration;
            }

            delete markerOverListenerArray[reg];
            delete markerOutListenerArray[reg];
            delete infoBoxArray[reg];


            markerOverListenerArray[reg] = google.maps.event.addListener( markerArray[reg], 'mouseover', function() {
                infoBoxArray[reg] = new google.maps.InfoWindow({
                    content: "Route: " + routeID + "<br />" + "Direction: " + directionID + "<br />" +  "Towards: "+ towards + "<br />" +  "Next Stop ID: " + nextStopID + "<br />" +  "Next Stop Name: " + nextStopName,
                    map: map
                });
                infoBoxArray[reg].open(map, this);
            });

            markerOutListenerArray[reg] = google.maps.event.addListener( markerArray[reg], 'mouseout', function() {
                infoBoxArray[reg].close();
            });

            nextArrivalTimeArray[reg] = nextArrivalTime;

            function timeoutFunc(reg, actualDuration, position, labelPosition, rotation, timeOut){
                setTimeout(function(){
                    if (timeOut > 0) { markerArray[reg].setVisible(true);}
                    markerArray[reg].setDuration(actualDuration);
                    markerArray[reg].labelAnchor = labelPosition;
                    markerArray[reg].label.setStyles();
                     markerArray[reg].setIcon({
                         path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                         scale: 8,
                         rotation: rotation
                     });
                     markerArray[reg].setPosition(position);
                },timeOut);
            }
        }


        function loadRouteIDs()
        {
            var routeIdCombo = document.getElementById("routeIDOption");
            var xmlhttp =new XMLHttpRequest();
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState==4 && xmlhttp.status==200)
                {
                    var parsedJson = JSON.parse(xmlhttp.responseText);
                    var routeArray = parsedJson.routeList;

                    for(var i = 0; i < routeArray.length; i++) {
                        var opt = routeArray[i];
                        var el = document.createElement("option");
                        el.textContent = opt;
                        el.value = opt;
                        routeIdCombo.appendChild(el);
                    }
                }
            };
            xmlhttp.open("GET","route_list_request.asp",true);
            xmlhttp.send();
        }

        function setUpWebSocket(routeSelection) {
            websocket = new WebSocket(wsUri);
            websocket.onopen = function(evt) {
                onOpen(evt, routeSelection)
            };
            websocket.onclose = function(evt) {
                onClose(evt)
            };
            websocket.onmessage = function(evt) {
                onMessage(evt)
            };
            websocket.onerror = function(evt) {
                onError(evt)
            };
        }
        function onOpen(evt, routeSelection) {

           // alert("CONNECTED");
            doSend(routeSelection);
        }
        function onClose(evt) {
            alert("DISCONNECTED");
        }
        function onMessage(evt) {
                var parsedJson = JSON.parse(evt.data);
                if (parsedJson.nextArr != "kill") {
                    setNewLocation(parsedJson.reg, parsedJson.nextArr, parsedJson.movementData, parsedJson.routeID, parsedJson.directionID, parsedJson.towards, parsedJson.nextStopID, parsedJson.nextStopName);
                }else {
                    deleteVehicle(parsedJson.reg);
                }
            }
        function onError(evt) {
            alert("ERROR: " + evt.data);
            //writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
        }
        function doSend(message) {
            websocket.send(message);
        }

    </script>
</head>
<body>
<div id="map_canvas"></div>
<div id="settings_canvas" class="settings">
    <div class="content">
    <div class="row">
        <label for="routeIDOption">Choose Route:</label>
        <select id="routeIDOption" multiple>
        </select>
            <button id="runButton">Run</button>
        </div>
    </div>
</div>

</body>
</html>